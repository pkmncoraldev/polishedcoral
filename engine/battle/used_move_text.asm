;MoveTable: ; - for Sour's move animation debugging
;;; Gen 1
;;	db TACKLE_SCRATCH_POUND
;;	db MULTI_MOVE_FURY_COMET_BARRAGE_SLAP_CANNON
;;	db PAY_DAY
;;	db FIRE_PUNCH
;;	db ICE_PUNCH
;;	db THUNDERPUNCH
;;	db SWORDS_DANCE 
;;	db CUT
;;	db GUST
;;	db WING_ATTACK
;;	db FLY
;;	db VINE_WHIP
;;	db STOMP
;;	db DOUBLE_KICK
;;	db JUMP_KICK
;;	db SAND_ATTACK_SMOKESCREEN_FLASH
;;	db HEADBUTT
;;	db HORN_ATTACK
;;	db BODY_SLAM
;;	db TAKE_DOWN
;;	db THRASH
;;	db DOUBLE_EDGE
;;	db LEER_TAIL_WHIP
;;	db POISON_STING
;;	db PIN_MISSILE
;;	db BITE
;;	db GROWL
;;	db ROAR_WHIRLWIND
;;	db SING_HYPNOSIS
;;	db SUPERSONIC
;;	db DISABLE
;;	db ACID
;;	db EMBER
;;	db FLAMETHROWER
;;	db WATER_GUN
;;	db HYDRO_PUMP
;;	db SURF
;;	db ICE_BEAM
;;	db BLIZZARD
;;	db PSYBEAM
;;	db BUBBLE_BEAM
;;	db AURORA_BEAM
;;	db HYPER_BEAM
;;	db PECK
;;	db DRILL_PECK
;;	db LOW_KICK
;;	db SEISMIC_TOSS
;;	db STRENGTH
;;	db ABSORB
;;	db MEGA_DRAIN
;;	db LEECH_SEED
;;	db WORK_UP_GROWTH
;;	db RAZOR_LEAF
;;	db SOLAR_BEAM
;;	db POISONPOWDER
;;	db STUN_SPORE
;;	db SLEEP_POWDER
;;	db PETAL_DANCE
;;	db SCARY_FACE_COTTON_SPORE_STRING_SHOT
;;	db DRAGON_RAGE
;;	db FIRE_SPIN
;;	db THUNDERSHOCK
;;	db THUNDERBOLT
;;	db THUNDER_WAVE
;;	db THUNDER
;;	db ROCK_THROW
;;	db EARTHQUAKE
;;	db DIG
;;	db TOXIC
;;	db CONFUSION
;;	db PSYCHIC_M
;;	db AGILITY_ROCK_POLISH
;;	db QUICK_ATTACK
;;	db RAGE
;;	db TELEPORT
;;	db NIGHT_SHADE
;;	db TRANSFORM_SKETCH_MIMIC_SPLASH_METRO
;;	db SCREECH
;;	db DOUBLE_TEAM
;;	db SOFTBOILED_MILK_DRINK_RECOVER
;;	db DEFENSE_CURL_HARDEN_WITHDRAW
;;	db MINIMIZE
;;	db CONFUSE_RAY
;;	db BARRIER_IRON_DEFENSE_ACID_ARMOR
;;	db LIGHT_SCREEN
;;	db HAZE
;;	db REFLECT
;;	db FOCUS_ENERGY
;;	db MIRROR_MOVE
;;	db SELFDESTRUCT
;;	db EGG_BOMB
;;	db SMOG
;;	db SLUDGE
;;	db BONE_CLUB
;;	db FIRE_BLAST
;;	db WATERFALL
;;	db SWIFT
;;	db AMNESIA
;;	db HI_JUMP_KICK
;;	db DREAM_EATER
;;	db LEECH_LIFE
;;	db SPORE
;;	db EXPLOSION
;;	db BONEMERANG
;;	db REST
;;	db ROCK_SLIDE
;;	db SHARPEN_HOWL_MEDITATE
;;	db CONVERSION
;;	db TRI_ATTACK
;;	db SLASH
;;	db SUBSTITUTE
;
;;; Gen 2
;;	db MEAN_LOOK_BLOCK_SPIDER_WEB
;;	db LOCK_ON_MIND_READER
;;	db SNORE
;;	db CURSE
;;	db FLAIL
;;	db CONVERSION2
;;	db REVERSAL
;;	db PROTECT
;;	db MACH_PUNCH
;;	db FEINT_ATTACK
;;	db BELLY_DRUM
;;	db SLUDGE_BOMB
;;	db MUD_SLAP
;;	db SPIKES
;;	db ZAP_CANNON
;;	db FORESIGHT_ODOR_SLEUTH_MIRACLE_EYE
;;	db DESTINY_BOND
;;	db PERISH_SONG
;;	db ICY_WIND
;;	db OUTRAGE
;;	db SANDSTORM
;;	db GIGA_DRAIN
;;	db ENDURE
;;	db CHARM_FEATHER_DANCE
;;	db ROLLOUT
;;	db FALSE_SWIPE
;;	db SWAGGER
;;	db SPARK
;;	db FURY_CUTTER
;;	db STEEL_WING
;;	db ATTRACT
;;	db HEAL_BELL
;;	db RETURN
;;	db SAFEGUARD
;;	db MAGNITUDE
;;	db DYNAMICPUNCH
;;	db MEGAHORN
;;	db DRAGONBREATH
;;	db BATON_PASS
;;	db ENCORE
;;	db PURSUIT
;;	db RAPID_SPIN
;;	db IRON_TAIL
;;	db METAL_CLAW
;;	db SYNTHESIS_MOONLIGHT_MORNING_SUN
;;	db CROSS_CHOP
;;	db TWISTER
;;	db RAIN_DANCE
;;	db SUNNY_DAY
;;	db CRUNCH
;;	db EXTREMESPEED
;;	db ANCIENTPOWER
;;	db SHADOW_BALL
;	db FUTURE_SIGHT  ; update anim
;;	db ROCK_SMASH
;
;;; Gen 3
;;	db FAKE_OUT
;;	db HAIL
;;	db WILL_O_WISP
;;	db TAUNT
;;	db WISH
;;	db SUPERPOWER
;;	db BRICK_BREAK
;;	db KNOCK_OFF
;;	db DIVE
;;	db HYPER_VOICE
;;	db POISON_FANG
;;	db WEATHER_BALL
;;	db COSMIC_POWER
;;	db SIGNAL_BEAM
;;	db BULLET_SEED
;;	db DRAGON_CLAW
;;	db BULK_UP
;;	db CALM_MIND
;;	db DRAGON_DANCE
;;	db ROCK_BLAST
;;	db SHOCK_WAVE
;
;;; Gen 4
;;	db ROOST
;;	db SUCKER_PUNCH
;;	db TOXIC_SPIKES
;;	db FLARE_BLITZ
;;	db AURA_SPHERE
;;	db POISON_JAB
;;	db DARK_PULSE
;;	db NIGHT_SLASH
;;	db AQUA_TAIL
;;	db AIR_SLASH
;;	db X_SCISSOR
;;	db BUG_BUZZ
;;	db DRAGON_PULSE
;;	db POWER_GEM
;;	db DRAIN_PUNCH
;;	db FOCUS_BLAST
;;	db ENERGY_BALL
;;	db BRAVE_BIRD
;;	db EARTH_POWER
;;	db GIGA_IMPACT
;;	db NASTY_PLOT
;;	db BULLET_PUNCH
;;	db ICE_SHARD
;;	db SHADOW_CLAW
;;	db THUNDER_FANG
;;	db ICE_FANG
;;	db FIRE_FANG
;;	db ZEN_HEADBUTT
;;	db FLASH_CANNON
;;	db ROCK_CLIMB
;;	db ROCK_WRECKER
;;	db GUNK_SHOT
;;	db STONE_EDGE
;;	db WOOD_HAMMER
;;	db AQUA_JET
;;	db DOUBLE_HIT
;;	db OMINOUS_WIND
;
;;; Gen 5
;;	db PSYSHOCK
;;	db VENOSHOCK
;;	db FLAME_BURST
;;	db QUIVER_DANCE
;;	db ELECTRO_BALL ; being cut
;;	db FLAME_CHARGE
;;	db CLEAR_SMOG
;;	db SCALD
;;	db SHELL_SMASH
;;	db HEX
;;	db ACROBATICS
;;	db BULLDOZE
;;	db WILD_CHARGE
;;	db HORN_LEECH
;;	db COTTON_GUARD
;;	db HURRICANE
;;	db FIERY_DANCE
;;	db ICICLE_CRASH
;
;;; Gen 6
;;	db PETAL_BLIZZARD
;;	db FAIRY_WIND
;;	db DAZZLINGLEAM
;;	db PLAY_ROUGH
;;	db MOONBLAST
;
;;; Gen 7
;;	db DRAGONHAMMER
;;	db SHADOW_BONE
;
;;; Gen 8
;;	db DRAGON_DARTS
;	db PSYSHIELD_BASH
;
;;; Gen 9
;	db LUMINA_CRASH
;;	db TWIN_BEAM
;
;;; Misc
;	db UNUSED
;	db 0

DisplayUsedMoveText:
;	ld a, BATTLE_VARS_MOVE	 ; this block is for testing all move animations
;	call GetBattleVarAddr
;	ld de, MoveTable
;.loop
;	ld a, [de]
;	inc de
;	and a
;	ret z
;	ld [hl], a
;	push hl
;	push de
;	farcall UpdateMoveData
;	call .do_it
;	farcall AnimateCurrentMove
;	pop de
;	pop hl
;	jr .loop

; battle command 03

	ldh a, [hBattleTurn]
	and a
	jr nz, .start

	ld a, [wPlayerMoveStruct + MOVE_ANIM]
	call UpdateUsedMoves

.start
	ld a, BATTLE_VARS_LAST_MOVE
	call GetBattleVarAddr
	ld d, h
	ld e, l

	ld a, BATTLE_VARS_LAST_COUNTER_MOVE
	call GetBattleVarAddr

	ld a, BATTLE_VARS_MOVE_ANIM
	call GetBattleVar
	ld [wd265], a

	push hl
	farcall CheckUserIsCharging
	pop hl
	jr nz, .charging

	; update last move
	ld a, [wd265]
	ld [hl], a
	ld [de], a

.charging
	; check obedience
	ld hl, UsedMoveText
	ld a, [wAlreadyDisobeyed]
	and a
	jr z, .ok
	ld hl, UsedMoveInsteadText
.ok
	call StdBattleTextBox
	jp ApplyTilemapInVBlank
; 105db9


UpdateUsedMoves: ; 105ed0
; append move a to wPlayerUsedMoves unless it has already been used

	push bc
; start of list
	ld hl, wPlayerUsedMoves
; get move id
	ld b, a
; next count
	ld c, NUM_MOVES

.loop
; get move from the list
	ld a, [hli]
; not used yet?
	and a
	jr z, .add
; already used?
	cp b
	jr z, .quit
; next byte
	dec c
	jr nz, .loop

; if the list is full and the move hasn't already been used
; shift the list back one byte, deleting the first move used
; this can occur with struggle or a new learned move
	ld hl, wPlayerUsedMoves + 1
; 1 = 2
	ld a, [hld]
	ld [hli], a
; 2 = 3
	inc hl
	ld a, [hld]
	ld [hli], a
; 3 = 4
	inc hl
	ld a, [hld]
	ld [hl], a
; 4 = new move
	ld a, b
	ld [wPlayerUsedMoves + 3], a
	jr .quit

.add
; go back to the byte we just inced from
	dec hl
; add the new move
	ld [hl], b

.quit
; list updated
	pop bc
	ret
; 105ef6
